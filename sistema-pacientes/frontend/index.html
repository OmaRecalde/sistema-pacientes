<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Pacientes</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        #app {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .error {
            border-color: #e74c3c !important;
        }

        .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
        }

        .success-message {
            color: #27ae60;
            font-size: 12px;
            margin-top: 5px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-active {
            background: #d4edda;
            color: #155724;
        }

        .badge-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            margin: 2px;
        }

        .btn-edit {
            background: #f39c12;
            color: white;
        }

        .btn-edit:hover {
            background: #e67e22;
        }

        .btn-toggle {
            background: #3498db;
            color: white;
        }

        .btn-toggle:hover {
            background: #2980b9;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>üè• Sistema de Gesti√≥n de Pacientes</h1>

        <div class="container">
            <!-- Listado de Pacientes -->
            <div class="card">
                <h2>üìã Listado de Pacientes</h2>

                <div v-if="loading" class="loading">Cargando pacientes...</div>
                <div v-else-if="error" class="error-message">{{ error }}</div>

                <table v-else>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>C√©dula</th>
                            <th>Correo</th>
                            <th>Edad</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="paciente in pacientes" :key="paciente.id">
                            <td>{{ paciente.id }}</td>
                            <td>{{ paciente.nombre }}</td>
                            <td>{{ paciente.cedula }}</td>
                            <td>{{ paciente.correo }}</td>
                            <td>{{ paciente.edad }}</td>
                            <td>
                                <span :class="paciente.activo ? 'badge badge-active' : 'badge badge-inactive'">
                                    {{ paciente.activo ? 'Activo' : 'Inactivo' }}
                                </span>
                            </td>
                            <td>
                                <button @click="editarPaciente(paciente)" class="btn-small btn-edit">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button @click="toggleEstado(paciente)" class="btn-small btn-toggle">
                                    {{ paciente.activo ? '‚ùå Desactivar' : '‚úÖ Activar' }}
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Formulario -->
            <div class="card">
                <h2>{{ isEditing ? '‚úèÔ∏è Editar Paciente' : '‚ûï Registrar Nuevo Paciente' }}</h2>

                <form @submit.prevent="submitForm">
                    <div class="form-group">
                        <label for="nombre">Nombre Completo *</label>
                        <input
                            type="text"
                            id="nombre"
                            v-model="form.nombre"
                            :class="{ error: formErrors.nombre }"
                            placeholder="Ej: Juan P√©rez Garc√≠a"
                        >
                        <div v-if="formErrors.nombre" class="error-message">{{ formErrors.nombre }}</div>
                    </div>

                    <div class="form-group">
                        <label for="cedula">C√©dula (10 d√≠gitos) *</label>
                        <input
                            type="text"
                            id="cedula"
                            v-model="form.cedula"
                            :class="{ error: formErrors.cedula }"
                            placeholder="Ej: 1234567890"
                            maxlength="10"
                        >
                        <div v-if="formErrors.cedula" class="error-message">{{ formErrors.cedula }}</div>
                    </div>

                    <div class="form-group">
                        <label for="correo">Correo Electr√≥nico *</label>
                        <input
                            type="email"
                            id="correo"
                            v-model="form.correo"
                            :class="{ error: formErrors.correo }"
                            placeholder="Ej: juan@email.com"
                        >
                        <div v-if="formErrors.correo" class="error-message">{{ formErrors.correo }}</div>
                    </div>

                    <div class="form-group">
                        <label for="edad">Edad *</label>
                        <input
                            type="number"
                            id="edad"
                            v-model="form.edad"
                            :class="{ error: formErrors.edad }"
                            placeholder="Ej: 35"
                            min="1"
                            max="150"
                        >
                        <div v-if="formErrors.edad" class="error-message">{{ formErrors.edad }}</div>
                    </div>

                    <div class="form-group">
                        <label for="direccion">Direcci√≥n *</label>
                        <input
                            type="text"
                            id="direccion"
                            v-model="form.direccion"
                            :class="{ error: formErrors.direccion }"
                            placeholder="Ej: Av. Am√©rica N23-45"
                        >
                        <div v-if="formErrors.direccion" class="error-message">{{ formErrors.direccion }}</div>
                    </div>

                    <div v-if="successMessage" class="success-message">{{ successMessage }}</div>
                    <div v-if="apiError" class="error-message">{{ apiError }}</div>

                    <div style="margin-top: 20px;">
                        <button type="submit" class="btn-primary">
                            {{ isEditing ? 'üíæ Actualizar' : '‚ûï Registrar' }}
                        </button>
                        <button type="button" @click="cancelar" class="btn-secondary" v-if="isEditing">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    pacientes: [],
                    loading: false,
                    error: null,
                    apiError: null,
                    successMessage: null,
                    isEditing: false,
                    editingId: null,
                    form: {
                        nombre: '',
                        cedula: '',
                        correo: '',
                        edad: '',
                        direccion: '',
                        activo: true
                    },
                    formErrors: {}
                }
            },
            mounted() {
                this.cargarPacientes();
            },
            methods: {
                async cargarPacientes() {
                    this.loading = true;
                    this.error = null;
                    try {
                        const response = await axios.get('http://localhost:8080/sistema_pacientes/api/pacientes');
                        this.pacientes = response.data;
                    } catch (error) {
                        this.error = 'Error al cargar pacientes: ' + error.message;
                    } finally {
                        this.loading = false;
                    }
                },

                validarCedulaEcuatoriana(cedula) {
                    // Validar c√≥digo de provincia (primeros 2 d√≠gitos)
                    const provincia = parseInt(cedula.substring(0, 2));
                    if ((provincia < 1 || provincia > 24) && provincia !== 30) {
                        return `El c√≥digo de provincia (${cedula.substring(0, 2)}) no es v√°lido. Debe estar entre 01-24 o ser 30`;
                    }

                    // Validar tercer d√≠gito (debe ser menor a 6)
                    const tercerDigito = parseInt(cedula.substring(2, 3));
                    if (tercerDigito >= 6) {
                        return `El tercer d√≠gito (${tercerDigito}) debe ser menor a 6`;
                    }

                    // Validar d√≠gito verificador con algoritmo de M√≥dulo 10
                    const coeficientes = [2, 1, 2, 1, 2, 1, 2, 1, 2];
                    let suma = 0;

                    for (let i = 0; i < 9; i++) {
                        let digito = parseInt(cedula.charAt(i));
                        let resultado = digito * coeficientes[i];

                        if (resultado >= 10) {
                            resultado -= 9;
                        }

                        suma += resultado;
                    }

                    const modulo = suma % 10;
                    const digitoVerificadorEsperado = modulo === 0 ? 0 : 10 - modulo;
                    const digitoVerificadorReal = parseInt(cedula.charAt(9));

                    if (digitoVerificadorEsperado !== digitoVerificadorReal) {
                        return 'El d√≠gito verificador es incorrecto. La c√©dula no es v√°lida';
                    }

                    return null; // C√©dula v√°lida
                },

                validarFormulario() {
                    this.formErrors = {};
                    let isValid = true;

                    if (!this.form.nombre || this.form.nombre.trim() === '') {
                        this.formErrors.nombre = 'El nombre es requerido';
                        isValid = false;
                    }

                    if (!this.form.cedula || this.form.cedula.trim() === '') {
                        this.formErrors.cedula = 'La c√©dula es requerida';
                        isValid = false;
                    } else if (!/^\d{10}$/.test(this.form.cedula)) {
                        this.formErrors.cedula = 'La c√©dula debe tener exactamente 10 d√≠gitos';
                        isValid = false;
                    } else {
                        // Validar c√©dula ecuatoriana
                        const errorCedula = this.validarCedulaEcuatoriana(this.form.cedula);
                        if (errorCedula) {
                            this.formErrors.cedula = errorCedula;
                            isValid = false;
                        }
                    }

                    if (!this.form.correo || this.form.correo.trim() === '') {
                        this.formErrors.correo = 'El correo es requerido';
                        isValid = false;
                    }

                    if (!this.form.edad || this.form.edad <= 0) {
                        this.formErrors.edad = 'La edad debe ser mayor a 0';
                        isValid = false;
                    }

                    if (!this.form.direccion || this.form.direccion.trim() === '') {
                        this.formErrors.direccion = 'La direcci√≥n es requerida';
                        isValid = false;
                    }

                    return isValid;
                },

                async submitForm() {
                    this.apiError = null;
                    this.successMessage = null;

                    if (!this.validarFormulario()) {
                        return;
                    }

                    try {
                        if (this.isEditing) {
                            await axios.put(
                                `http://localhost:8080/sistema_pacientes/api/pacientes/${this.editingId}`,
                                this.form
                            );
                            this.successMessage = 'Paciente actualizado exitosamente';
                        } else {
                            await axios.post(
                                'http://localhost:8080/sistema_pacientes/api/pacientes',
                                this.form
                            );
                            this.successMessage = 'Paciente registrado exitosamente';
                        }

                        this.resetForm();
                        await this.cargarPacientes();

                        setTimeout(() => {
                            this.successMessage = null;
                        }, 3000);

                    } catch (error) {
                        if (error.response && error.response.data && error.response.data.error) {
                            this.apiError = error.response.data.error;
                        } else {
                            this.apiError = 'Error al procesar la solicitud: ' + error.message;
                        }
                    }
                },

                editarPaciente(paciente) {
                    this.isEditing = true;
                    this.editingId = paciente.id;
                    this.form = {
                        nombre: paciente.nombre,
                        cedula: paciente.cedula,
                        correo: paciente.correo,
                        edad: paciente.edad,
                        direccion: paciente.direccion,
                        activo: paciente.activo
                    };
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },

                async toggleEstado(paciente) {
                    try {
                        await axios.put(
                            `http://localhost:8080/sistema_pacientes/api/pacientes/${paciente.id}/estado`
                        );
                        await this.cargarPacientes();
                    } catch (error) {
                        this.apiError = 'Error al cambiar estado: ' + error.message;
                    }
                },

                cancelar() {
                    this.resetForm();
                },

                resetForm() {
                    this.isEditing = false;
                    this.editingId = null;
                    this.form = {
                        nombre: '',
                        cedula: '',
                        correo: '',
                        edad: '',
                        direccion: '',
                        activo: true
                    };
                    this.formErrors = {};
                    this.apiError = null;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
